<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="Track informal loans between friends and family with transparency and accountability">
    <title>Trust Lending Manager</title>
    <style>
        /* ========================================
           CSS RESET & BASE STYLES
           ======================================== */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            /* Color Palette */
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --neutral: #6c757d;
            --bg-card: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;

            /* Typography */
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;

            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;

            /* Border Radius */
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }

        body {
            font-family: var(--font-family);
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-primary);
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: var(--spacing-md);
        }

        /* ========================================
           LAYOUT
           ======================================== */
        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-lg) 0;
        }

        header h1 {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        /* ========================================
           CARDS
           ======================================== */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .card-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        /* ========================================
           STATISTICS DASHBOARD
           ======================================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            text-align: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: var(--spacing-xs);
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* ========================================
           FORM STYLES
           ======================================== */
        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
            color: var(--text-primary);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 1em;
            font-family: inherit;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Loan Type Toggle */
        .loan-type-toggle {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .type-option {
            flex: 1;
            position: relative;
        }

        .type-option input {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .type-option label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: 14px 20px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .type-option input:checked+label {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .type-option label:hover {
            border-color: var(--primary);
        }

        /* ========================================
           BUTTONS
           ======================================== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 1em;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px;
            min-width: 44px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--neutral);
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .btn-block {
            width: 100%;
        }

        .btn-group {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
            margin-top: var(--spacing-md);
        }

        /* ========================================
           LOAN CARDS
           ======================================== */
        .loan-item {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border-left: 4px solid var(--primary);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .loan-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        }

        .loan-item.completed {
            opacity: 0.7;
            border-left-color: var(--success);
        }

        .loan-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-md);
            gap: var(--spacing-md);
        }

        .loan-person {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--text-primary);
        }

        .loan-type {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .loan-amount {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--primary);
            white-space: nowrap;
        }

        .loan-details {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
        }

        .loan-details>div {
            margin-bottom: var(--spacing-xs);
        }

        /* Progress Bar */
        .progress-container {
            margin: var(--spacing-md) 0;
        }

        .progress-bar {
            height: 12px;
            background: var(--border-color);
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--success) 100%);
            border-radius: 6px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-top: var(--spacing-xs);
            display: flex;
            justify-content: space-between;
        }

        /* Payment History */
        .payment-history {
            margin-top: var(--spacing-md);
            padding-top: var(--spacing-md);
            border-top: 1px solid var(--border-color);
        }

        .payment-history-title {
            font-size: 0.9em;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .payment-item {
            display: flex;
            justify-content: space-between;
            padding: var(--spacing-sm) 0;
            font-size: 0.9em;
            border-bottom: 1px solid var(--border-color);
        }

        .payment-item:last-child {
            border-bottom: none;
        }

        .payment-amount {
            color: var(--success);
            font-weight: 600;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: var(--spacing-sm);
        }

        .badge-success {
            background: rgba(40, 167, 69, 0.15);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(220, 53, 69, 0.15);
            color: var(--danger);
        }

        .badge-info {
            background: rgba(23, 162, 184, 0.15);
            color: var(--info);
        }

        .completed-badge {
            color: var(--success);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: var(--spacing-md);
        }

        /* ========================================
           MODALS
           ======================================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-md);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .modal-title {
            font-size: 1.3em;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--text-secondary);
            padding: var(--spacing-sm);
            line-height: 1;
            transition: color 0.2s ease;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        /* Reminder Templates */
        .template-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .template-item {
            padding: var(--spacing-md);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .template-item:hover {
            border-color: var(--primary);
            background: rgba(102, 126, 234, 0.05);
        }

        .template-item.selected {
            border-color: var(--primary);
            background: rgba(102, 126, 234, 0.1);
        }

        /* ========================================
           NOTIFICATIONS
           ======================================== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: var(--radius-sm);
            color: white;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }

        .notification-success {
            background: var(--success);
        }

        .notification-error {
            background: var(--danger);
        }

        .notification-info {
            background: var(--info);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* ========================================
           SECTIONS
           ======================================== */
        .section-title {
            font-size: 1.2em;
            font-weight: 700;
            color: white;
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .section-title span {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
        }

        /* ========================================
           RESPONSIVE DESIGN
           ======================================== */
        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }

            .loan-header {
                flex-direction: column;
            }

            .loan-amount {
                align-self: flex-start;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn-group .btn {
                width: 100%;
            }
        }

        /* ========================================
           ACCESSIBILITY
           ======================================== */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        :focus-visible {
            outline: 3px solid var(--primary);
            outline-offset: 2px;
        }

        /* ========================================
           FOOTER
           ======================================== */
        footer {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            padding: var(--spacing-lg) 0;
            font-size: 0.9em;
        }

        footer a {
            color: white;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header>
            <h1>ü§ù Trust Lending Manager</h1>
            <p>Track loans with friends & family ‚Äî keep relationships strong</p>
        </header>

        <!-- Statistics Dashboard -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-value" id="statActiveLoans">0</div>
                <div class="stat-label">Active Loans</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statOutstanding">$0.00</div>
                <div class="stat-label">Total Outstanding</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statCollected">$0.00</div>
                <div class="stat-label">Total Collected</div>
            </div>
        </div>

        <!-- Create New Loan Form -->
        <div class="card">
            <h2 class="card-title">‚ûï Create New Loan</h2>
            <form id="loanForm">
                <div class="loan-type-toggle">
                    <div class="type-option">
                        <input type="radio" id="typeLender" name="loanType" value="lender" checked>
                        <label for="typeLender">üì§ I'm Lending</label>
                    </div>
                    <div class="type-option">
                        <input type="radio" id="typeBorrower" name="loanType" value="borrower">
                        <label for="typeBorrower">üì• I'm Borrowing</label>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="personName">Person Name *</label>
                        <input type="text" id="personName" name="personName" required maxlength="100"
                            placeholder="Who are you lending to / borrowing from?">
                    </div>
                    <div class="form-group">
                        <label for="amount">Amount ($) *</label>
                        <input type="number" id="amount" name="amount" required min="0.01" step="0.01"
                            placeholder="0.00">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="dueDate">Due Date (optional)</label>
                        <input type="date" id="dueDate" name="dueDate">
                    </div>
                    <div class="form-group">
                        <label for="purpose">Purpose (optional)</label>
                        <input type="text" id="purpose" name="purpose" maxlength="200"
                            placeholder="What's the loan for?">
                    </div>
                </div>

                <div class="form-group">
                    <label for="notes">Notes (optional)</label>
                    <textarea id="notes" name="notes" maxlength="1000"
                        placeholder="Any additional details..."></textarea>
                </div>

                <button type="submit" class="btn btn-primary btn-block">Create Loan Record</button>
            </form>
        </div>

        <!-- Active Loans Section -->
        <h2 class="section-title">üìã Active Loans <span id="activeCount">0</span></h2>
        <div id="loansList">
            <div class="empty-state">
                <div class="empty-state-icon">üìù</div>
                <p>No active loans yet. Create your first loan record above!</p>
            </div>
        </div>

        <!-- Completed Loans Section -->
        <h2 class="section-title">‚úÖ Completed Loans <span id="completedCount">0</span></h2>
        <div id="completedLoansList">
            <div class="empty-state">
                <div class="empty-state-icon">üéâ</div>
                <p>No completed loans yet.</p>
            </div>
        </div>

        <!-- Footer -->
        <footer>
            <p>Trust Lending Manager v1.0.0 ‚Ä¢ Data stored locally in your browser</p>
        </footer>
    </div>

    <!-- Payment Modal -->
    <div class="modal-overlay" id="paymentModal">
        <div class="modal" role="dialog" aria-labelledby="paymentModalTitle">
            <div class="modal-header">
                <h3 class="modal-title" id="paymentModalTitle">üí∞ Record Payment</h3>
                <button class="modal-close" onclick="closePaymentModal()" aria-label="Close modal">&times;</button>
            </div>
            <form id="paymentForm">
                <div class="form-group">
                    <label for="paymentAmount">Payment Amount ($) *</label>
                    <input type="number" id="paymentAmount" name="paymentAmount" required min="0.01" step="0.01">
                </div>
                <div class="form-group">
                    <label for="paymentDate">Payment Date *</label>
                    <input type="date" id="paymentDate" name="paymentDate" required>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-success">Record Payment</button>
                    <button type="button" class="btn btn-secondary" onclick="closePaymentModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reminder Modal -->
    <div class="modal-overlay" id="reminderModal">
        <div class="modal" role="dialog" aria-labelledby="reminderModalTitle">
            <div class="modal-header">
                <h3 class="modal-title" id="reminderModalTitle">üì® Send Reminder</h3>
                <button class="modal-close" onclick="closeReminderModal()" aria-label="Close modal">&times;</button>
            </div>
            <p style="margin-bottom: var(--spacing-md); color: var(--text-secondary);">Select a template or write your
                own message:</p>
            <div class="template-list" id="templateList"></div>
            <div class="form-group">
                <label for="customMessage">Custom Message</label>
                <textarea id="customMessage" rows="4"
                    placeholder="Write your own message or click a template above..."></textarea>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-primary" onclick="copyReminderMessage()">üìã Copy Message</button>
                <button type="button" class="btn btn-secondary" onclick="closeReminderModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        /* ========================================
           APPLICATION STATE
           ======================================== */
        const APP_VERSION = '1.0.0';
        const STORAGE_KEY = 'trustLoans';
        const DATA_VERSION = 1;

        let loans = [];
        let currentPaymentLoanId = null;
        let currentReminderLoanId = null;

        /* ========================================
           ERROR HANDLING (TRD Section 8.1)
           ======================================== */

        /**
         * Error codes for loan operations
         */
        const ERROR_CODES = {
            VALIDATION_FAILED: 'VALIDATION_FAILED',
            STORAGE_FULL: 'STORAGE_FULL',
            NOT_FOUND: 'NOT_FOUND',
            DUPLICATE: 'DUPLICATE',
            INVALID_OPERATION: 'INVALID_OPERATION'
        };

        /**
         * Custom error class for loan operations
         */
        class LoanError extends Error {
            constructor(message, code) {
                super(message);
                this.name = 'LoanError';
                this.code = code;
            }
        }

        /* ========================================
           UTILITY FUNCTIONS
           ======================================== */

        /**
         * Escapes HTML to prevent XSS attacks
         * @param {string} text - Text to escape
         * @returns {string} Escaped text
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * Formats a number as currency
         * @param {number} amount - Amount to format
         * @returns {string} Formatted currency string
         */
        function formatCurrency(amount) {
            return amount.toFixed(2);
        }

        /**
         * Calculates days until a due date
         * @param {string} dueDate - ISO date string
         * @returns {number} Days until due (negative if overdue)
         */
        function calculateDaysUntilDue(dueDate) {
            const due = new Date(dueDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            due.setHours(0, 0, 0, 0);

            const diffTime = due - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            return diffDays;
        }

        /**
         * Shows a notification toast
         * @param {string} message - Notification message
         * @param {string} type - Notification type (success, error, info)
         */
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            notification.setAttribute('role', 'alert');

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease forwards';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        /* ========================================
           STORAGE FUNCTIONS
           ======================================== */

        /**
         * Migrates data from older versions to current version
         * @param {Array} loansData - Array of loan objects
         * @param {number} fromVersion - Source data version
         * @returns {Array} Migrated loan data
         */
        function migrateData(loansData, fromVersion) {
            let data = [...loansData];

            // Future migrations can be added here
            // Example:
            // if (fromVersion < 2) {
            //     data = data.map(loan => ({
            //         ...loan,
            //         newField: 'default value'
            //     }));
            // }

            return data;
        }

        /**
         * Saves loans to localStorage with version info
         * @returns {boolean} Success status
         */
        function saveLoans() {
            try {
                const data = {
                    version: DATA_VERSION,
                    loans: loans
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                return true;
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    showNotification('Storage full. Please delete some old loans.', 'error');
                    throw new LoanError('Storage full. Please delete some old loans.', ERROR_CODES.STORAGE_FULL);
                } else {
                    showNotification('Failed to save data.', 'error');
                    throw new LoanError('Failed to save data.', ERROR_CODES.INVALID_OPERATION);
                }
            }
        }

        /**
         * Loads loans from localStorage with migration support
         * @returns {Array} Array of loan objects
         */
        function loadLoans() {
            try {
                const rawData = localStorage.getItem(STORAGE_KEY);
                if (!rawData) return [];

                const data = JSON.parse(rawData);

                // Handle legacy format (array without version wrapper)
                if (Array.isArray(data)) {
                    console.log('Migrating legacy data format to versioned format');
                    return migrateData(data, 0);
                }

                // Handle versioned data
                const version = data.version || 0;
                const loansData = data.loans || [];

                // Migrate if needed
                if (version < DATA_VERSION) {
                    console.log(`Migrating data from v${version} to v${DATA_VERSION}`);
                    return migrateData(loansData, version);
                }

                return loansData;
            } catch (e) {
                console.error('Load failed:', e);
                showNotification('Failed to load data.', 'error');
                return [];
            }
        }

        /* ========================================
           LOAN MANAGEMENT
           ======================================== */

        /**
         * Validates loan input data
         * @param {Object} data - Loan data
         * @returns {Object} Validation result with valid flag and errors array
         */
        function validateLoanInput(data) {
            const errors = [];

            // Person name validation
            if (!data.personName || data.personName.trim().length === 0) {
                errors.push('Person name is required');
            }
            if (data.personName && data.personName.length > 100) {
                errors.push('Person name must be less than 100 characters');
            }

            // Amount validation
            if (!data.amount || isNaN(data.amount)) {
                errors.push('Valid amount is required');
            }
            if (data.amount <= 0) {
                errors.push('Amount must be greater than $0');
            }
            if (data.amount > 1000000) {
                errors.push('Amount must be less than $1,000,000');
            }

            // Due date validation (TRD Section 7.1)
            if (data.dueDate) {
                const date = new Date(data.dueDate);
                if (isNaN(date.getTime())) {
                    errors.push('Invalid due date format');
                }
            }

            // Purpose and notes length validation (TRD Section 7.1)
            if (data.purpose && data.purpose.length > 200) {
                errors.push('Purpose must be less than 200 characters');
            }
            if (data.notes && data.notes.length > 1000) {
                errors.push('Notes must be less than 1000 characters');
            }

            return { valid: errors.length === 0, errors };
        }

        /**
         * Creates a new loan
         * @param {Object} loanData - Loan information
         * @returns {Object|null} Created loan or null on failure
         */
        function createLoan(loanData) {
            const validation = validateLoanInput(loanData);
            if (!validation.valid) {
                showNotification(validation.errors[0], 'error');
                return null;
            }

            const loan = {
                id: Date.now(),
                type: loanData.type || 'lender',
                personName: loanData.personName.trim(),
                amount: parseFloat(parseFloat(loanData.amount).toFixed(2)),
                dueDate: loanData.dueDate || null,
                purpose: (loanData.purpose || '').trim(),
                notes: (loanData.notes || '').trim(),
                createdDate: new Date().toISOString().split('T')[0],
                completed: false,
                payments: []
            };

            loans.push(loan);
            saveLoans();

            return loan;
        }

        /**
         * Deletes a loan
         * @param {number} loanId - Loan ID
         * @returns {boolean} Success status
         */
        function deleteLoan(loanId) {
            const index = loans.findIndex(l => l.id === loanId);
            if (index === -1) {
                throw new LoanError('Loan not found', ERROR_CODES.NOT_FOUND);
            }

            loans.splice(index, 1);
            saveLoans();

            return true;
        }

        /**
         * Updates an existing loan (TRD Section 4.1)
         * @param {Number} loanId - Loan ID
         * @param {Object} updates - Fields to update
         * @returns {Object|null} Updated loan or null
         */
        function updateLoan(loanId, updates) {
            const loan = loans.find(l => l.id === loanId);

            if (!loan) {
                throw new LoanError('Loan not found', ERROR_CODES.NOT_FOUND);
            }

            // Protected fields that cannot be modified
            const protectedFields = ['id', 'createdDate', 'payments'];

            // Apply updates
            Object.keys(updates).forEach(key => {
                if (updates[key] !== undefined && !protectedFields.includes(key)) {
                    loan[key] = updates[key];
                }
            });

            saveLoans();
            return loan;
        }

        /**
         * Calculates progress for a loan
         * @param {Object} loan - Loan object
         * @returns {Object} Progress info with totalPaid, remaining, percentage, isComplete
         */
        function calculateProgress(loan) {
            const totalPaid = loan.payments.reduce((sum, p) => sum + p.amount, 0);
            const remaining = Math.max(0, loan.amount - totalPaid);
            const percentage = Math.min(100, (totalPaid / loan.amount) * 100);

            return {
                totalPaid: parseFloat(totalPaid.toFixed(2)),
                remaining: parseFloat(remaining.toFixed(2)),
                percentage: percentage,
                isComplete: totalPaid >= loan.amount
            };
        }

        /**
         * Records a payment for a loan
         * @param {number} loanId - Loan ID
         * @param {number} amount - Payment amount
         * @param {string} date - Payment date
         * @returns {boolean} Success status
         */
        function recordPayment(loanId, amount, date) {
            const loan = loans.find(l => l.id === loanId);
            if (!loan) return false;

            if (amount <= 0) {
                showNotification('Payment amount must be greater than $0', 'error');
                return false;
            }

            const today = new Date();
            today.setHours(23, 59, 59, 999);
            if (new Date(date) > today) {
                showNotification('Payment date cannot be in the future', 'error');
                return false;
            }

            const payment = {
                amount: parseFloat(parseFloat(amount).toFixed(2)),
                date: date
            };

            loan.payments.push(payment);

            // Check if loan is completed
            const progress = calculateProgress(loan);
            if (progress.isComplete) {
                loan.completed = true;
            }

            saveLoans();
            return true;
        }

        /**
         * Calculates dashboard statistics
         * @returns {Object} Statistics object
         */
        function calculateStatistics() {
            const activeLoans = loans.filter(l => !l.completed);

            let totalOutstanding = 0;
            let totalCollected = 0;

            loans.forEach(loan => {
                const progress = calculateProgress(loan);
                totalCollected += progress.totalPaid;
                if (!loan.completed) {
                    totalOutstanding += progress.remaining;
                }
            });

            return {
                activeLoans: activeLoans.length,
                totalOutstanding: parseFloat(totalOutstanding.toFixed(2)),
                totalCollected: parseFloat(totalCollected.toFixed(2))
            };
        }

        /* ========================================
           REMINDER TEMPLATES
           ======================================== */

        /**
         * Generates reminder templates for a loan
         * @param {Object} loan - Loan object
         * @returns {Array<string>} Array of template messages
         */
        function generateReminderTemplates(loan) {
            const progress = calculateProgress(loan);
            const remaining = progress.remaining;
            const dueDateText = loan.dueDate ? `The due date is ${loan.dueDate}.` : '';

            if (loan.type === 'lender') {
                return [
                    `Hi ${loan.personName}! üëã Just a friendly reminder about the $${formatCurrency(remaining)} loan. No rush, but wanted to check in and see how you're doing. Let me know if you need to adjust the repayment plan. Thanks!`,
                    `Hey ${loan.personName}! Hope you're doing well. I wanted to gently remind you about the outstanding balance of $${formatCurrency(remaining)}. ${dueDateText} Let me know if you have any questions!`,
                    `Hi ${loan.personName}, this is a friendly reminder about the loan. Remaining balance: $${formatCurrency(remaining)}. I understand if circumstances have changed - let's chat if you need to work something out. ü§ù`
                ];
            } else {
                return [
                    `Hi ${loan.personName}! üëã Quick reminder that I still owe you $${formatCurrency(remaining)}. I haven't forgotten! Will get this sorted out soon. Thanks for your patience!`,
                    `Hey ${loan.personName}! Just wanted to let you know I'm working on getting you the $${formatCurrency(remaining)} I owe. ${dueDateText} Appreciate your understanding!`,
                    `Hi ${loan.personName}, reminding myself that I need to pay you back $${formatCurrency(remaining)}. I'll reach out soon to arrange the payment. Thanks for being patient with me! üôè`
                ];
            }
        }

        /**
         * Copies text to clipboard
         * @param {string} text - Text to copy
         * @returns {Promise<boolean>} Success status
         */
        async function copyToClipboard(text) {
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                    return true;
                }

                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();

                const success = document.execCommand('copy');
                document.body.removeChild(textarea);

                return success;
            } catch (error) {
                console.error('Copy failed:', error);
                return false;
            }
        }

        /* ========================================
           UI RENDERING
           ======================================== */

        /**
         * Renders due date badge
         * @param {Object} loan - Loan object
         * @returns {string} HTML string
         */
        function renderDueDateBadge(loan) {
            if (!loan.dueDate || loan.completed) return '';

            const daysUntil = calculateDaysUntilDue(loan.dueDate);

            if (daysUntil < 0) {
                return `<span class="badge badge-warning">Overdue by ${Math.abs(daysUntil)} day${Math.abs(daysUntil) !== 1 ? 's' : ''}</span>`;
            } else if (daysUntil === 0) {
                return `<span class="badge badge-warning">Due today</span>`;
            } else if (daysUntil <= 7) {
                return `<span class="badge badge-info">Due in ${daysUntil} day${daysUntil !== 1 ? 's' : ''}</span>`;
            } else {
                return `<span class="badge badge-success">Due ${loan.dueDate}</span>`;
            }
        }

        /**
         * Renders payment history
         * @param {Object} loan - Loan object
         * @returns {string} HTML string
         */
        function renderPaymentHistory(loan) {
            if (loan.payments.length === 0) return '';

            const sortedPayments = [...loan.payments].sort((a, b) => new Date(b.date) - new Date(a.date));

            const paymentsHtml = sortedPayments.map(p => `
                <div class="payment-item">
                    <span>${p.date}</span>
                    <span class="payment-amount">+$${formatCurrency(p.amount)}</span>
                </div>
            `).join('');

            return `
                <div class="payment-history">
                    <div class="payment-history-title">üìú Payment History (${loan.payments.length})</div>
                    ${paymentsHtml}
                </div>
            `;
        }

        /**
         * Renders a single loan card
         * @param {Object} loan - Loan object
         * @returns {string} HTML string
         */
        function renderLoanCard(loan) {
            const progress = calculateProgress(loan);
            const roleIcon = loan.type === 'lender' ? 'üì§' : 'üì•';
            const roleText = loan.type === 'lender' ? 'You lent' : 'You borrowed';
            const dueDateBadge = renderDueDateBadge(loan);

            const progressSection = loan.completed
                ? `<div class="completed-badge">‚úì Fully Repaid</div>`
                : `
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress.percentage}%"></div>
                        </div>
                        <div class="progress-text">
                            <span>Paid: $${formatCurrency(progress.totalPaid)}</span>
                            <span>Remaining: $${formatCurrency(progress.remaining)}</span>
                        </div>
                    </div>
                `;

            const actionButtons = loan.completed
                ? `
                    <div class="btn-group">
                        <button class="btn btn-danger btn-sm" onclick="confirmDeleteLoan(${loan.id})">üóëÔ∏è Delete Record</button>
                    </div>
                `
                : `
                    <div class="btn-group">
                        <button class="btn btn-success btn-sm" onclick="openPaymentModal(${loan.id})">üí∞ Record Payment</button>
                        <button class="btn btn-primary btn-sm" onclick="openReminderModal(${loan.id})">üì® Send Reminder</button>
                        <button class="btn btn-danger btn-sm" onclick="confirmDeleteLoan(${loan.id})">üóëÔ∏è Delete</button>
                    </div>
                `;

            return `
                <div class="loan-item ${loan.completed ? 'completed' : ''}">
                    <div class="loan-header">
                        <div>
                            <div class="loan-person">${escapeHtml(loan.personName)}</div>
                            <div class="loan-type">${roleIcon} ${roleText}</div>
                        </div>
                        <div class="loan-amount">$${formatCurrency(loan.amount)}</div>
                    </div>
                    
                    <div class="loan-details">
                        ${loan.purpose ? `<div><strong>Purpose:</strong> ${escapeHtml(loan.purpose)}</div>` : ''}
                        <div><strong>Created:</strong> ${loan.createdDate}</div>
                        ${loan.dueDate ? `<div><strong>Due Date:</strong> ${loan.dueDate} ${dueDateBadge}</div>` : ''}
                        ${loan.notes ? `<div><strong>Notes:</strong> ${escapeHtml(loan.notes)}</div>` : ''}
                    </div>
                    
                    ${progressSection}
                    ${renderPaymentHistory(loan)}
                    ${actionButtons}
                </div>
            `;
        }

        /**
         * Renders all loans
         */
        function renderLoans() {
            const activeLoans = loans.filter(l => !l.completed);
            const completedLoans = loans.filter(l => l.completed);

            // Update counts
            document.getElementById('activeCount').textContent = activeLoans.length;
            document.getElementById('completedCount').textContent = completedLoans.length;

            // Render active loans
            const activeList = document.getElementById('loansList');
            if (activeLoans.length === 0) {
                activeList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <p>No active loans yet. Create your first loan record above!</p>
                    </div>
                `;
            } else {
                activeList.innerHTML = activeLoans
                    .sort((a, b) => b.id - a.id)
                    .map(loan => renderLoanCard(loan))
                    .join('');
            }

            // Render completed loans
            const completedList = document.getElementById('completedLoansList');
            if (completedLoans.length === 0) {
                completedList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéâ</div>
                        <p>No completed loans yet.</p>
                    </div>
                `;
            } else {
                completedList.innerHTML = completedLoans
                    .sort((a, b) => b.id - a.id)
                    .map(loan => renderLoanCard(loan))
                    .join('');
            }
        }

        /**
         * Updates statistics display
         */
        function updateStatistics() {
            const stats = calculateStatistics();

            document.getElementById('statActiveLoans').textContent = stats.activeLoans;
            document.getElementById('statOutstanding').textContent = `$${formatCurrency(stats.totalOutstanding)}`;
            document.getElementById('statCollected').textContent = `$${formatCurrency(stats.totalCollected)}`;
        }

        /* ========================================
           MODAL FUNCTIONS
           ======================================== */

        function openPaymentModal(loanId) {
            currentPaymentLoanId = loanId;

            const loan = loans.find(l => l.id === loanId);
            if (!loan) return;

            const progress = calculateProgress(loan);

            // Pre-fill remaining amount
            document.getElementById('paymentAmount').value = progress.remaining.toFixed(2);

            // Set today's date
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];

            // Show modal
            document.getElementById('paymentModal').classList.add('active');
            document.getElementById('paymentAmount').focus();
        }

        function closePaymentModal() {
            currentPaymentLoanId = null;
            document.getElementById('paymentModal').classList.remove('active');
            document.getElementById('paymentForm').reset();
        }

        function openReminderModal(loanId) {
            currentReminderLoanId = loanId;

            const loan = loans.find(l => l.id === loanId);
            if (!loan) return;

            const templates = generateReminderTemplates(loan);
            const templateList = document.getElementById('templateList');

            templateList.innerHTML = templates.map((template, index) => `
                <div class="template-item" onclick="selectTemplate(this, '${escapeHtml(template).replace(/'/g, "\\'")}')">
                    ${escapeHtml(template)}
                </div>
            `).join('');

            document.getElementById('customMessage').value = '';
            document.getElementById('reminderModal').classList.add('active');
        }

        function closeReminderModal() {
            currentReminderLoanId = null;
            document.getElementById('reminderModal').classList.remove('active');
            document.getElementById('customMessage').value = '';
        }

        function selectTemplate(element, templateText) {
            // Remove selected class from all templates
            document.querySelectorAll('.template-item').forEach(el => el.classList.remove('selected'));

            // Add selected class to clicked template
            element.classList.add('selected');

            // Populate custom message field
            document.getElementById('customMessage').value = templateText;
        }

        async function copyReminderMessage() {
            const message = document.getElementById('customMessage').value.trim();

            if (!message) {
                showNotification('Please select a template or write a message', 'error');
                return;
            }

            const success = await copyToClipboard(message);

            if (success) {
                showNotification('Message copied to clipboard!', 'success');
                closeReminderModal();
            } else {
                showNotification('Failed to copy message', 'error');
            }
        }

        function confirmDeleteLoan(loanId) {
            if (confirm('Are you sure you want to delete this loan record? This cannot be undone.')) {
                if (deleteLoan(loanId)) {
                    renderLoans();
                    updateStatistics();
                    showNotification('Loan record deleted', 'success');
                }
            }
        }

        /* ========================================
           EVENT LISTENERS
           ======================================== */

        // Loan form submission
        document.getElementById('loanForm').addEventListener('submit', (event) => {
            event.preventDefault();

            const formData = {
                type: document.querySelector('input[name="loanType"]:checked').value,
                personName: document.getElementById('personName').value,
                amount: parseFloat(document.getElementById('amount').value),
                dueDate: document.getElementById('dueDate').value || null,
                purpose: document.getElementById('purpose').value,
                notes: document.getElementById('notes').value
            };

            const loan = createLoan(formData);

            if (loan) {
                renderLoans();
                updateStatistics();
                event.target.reset();
                document.getElementById('typeLender').checked = true;
                showNotification('Loan record created successfully!', 'success');
            }
        });

        // Payment form submission
        document.getElementById('paymentForm').addEventListener('submit', (event) => {
            event.preventDefault();

            if (!currentPaymentLoanId) return;

            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const date = document.getElementById('paymentDate').value;

            if (recordPayment(currentPaymentLoanId, amount, date)) {
                renderLoans();
                updateStatistics();
                closePaymentModal();
                showNotification('Payment recorded successfully!', 'success');
            }
        });

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (event) => {
                if (event.target === overlay) {
                    if (overlay.id === 'paymentModal') {
                        closePaymentModal();
                    } else if (overlay.id === 'reminderModal') {
                        closeReminderModal();
                    }
                }
            });
        });

        // Close modals on Escape key
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closePaymentModal();
                closeReminderModal();
            }
        });

        /* ========================================
           INITIALIZATION
           ======================================== */

        function init() {
            loans = loadLoans();
            renderLoans();
            updateStatistics();

            console.log(`Trust Lending Manager v${APP_VERSION} initialized`);
        }

        // Start app when DOM is ready
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>